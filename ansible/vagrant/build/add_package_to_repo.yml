---

- hosts: localhost
  vars_files:
    - vars/repository.yml

  tasks:

    - name: Make sure a repo box is running
      shell: vagrant up chdir=./vm/{{ repo_host }}

    - name: Copy vagrant user's private key
      shell: cp  ./.vagrant/machines/default/virtualbox/private_key \
             ../../files/vagrant_key/
             chdir=./vm/{{ repo_host }}

- hosts: "{{ repo_host }}"
  become: True
  vars:
    repo_datetime: "{{ ansible_date_time.iso8601 }}"
  vars_files:
    - vars/package.yml
    - vars/build-box.yml
    - vars/repository.yml

  tasks:

    - name: Fetch repo box's certificate
      fetch: dest=./roles/prepare_install_zato/files/ \
             src=/etc/apache2/ssl/repo-box-ubuntu.crt
             fail_on_missing=yes

  roles:

    - add_package_to_repo
