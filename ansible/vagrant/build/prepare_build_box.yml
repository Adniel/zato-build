---

  - hosts: localhost

    tasks:

    # Prepare vars file for "build" provisioner
      - name: Add "system" variable
        replace: dest=./vars/parameters.yml regexp="zato_system" replace={{ system }}

      - name: Add "release_version" variable
        replace: dest=./vars/parameters.yml regexp="zato_release_version" replace={{ release_version }}

      - name: Add "package_version" variable
        replace: dest=./vars/parameters.yml regexp="zato_package_version" replace={{ package_version }}

      - name: Add "branch" variable
        replace: dest=./vars/parameters.yml regexp="zato_branch" replace={{ branch }}

    # Prepare build box
      - name: Prepare Vagrantfile
        template: src=./templates/base_box.j2 dest=vm/{{ system }}/Vagrantfile

      - name: Create "synced" directory
        file: path=./vm/{{ system }}/synced state=directory

      - name: Clone Zato repository to the synced directory
        git: repo=https://github.com/zatosource/zato-build.git dest=./vm/{{ system }}/synced clone=yes

      - name: Create a vagrant box
        shell: vagrant up chdir=./vm/{{ system }}
