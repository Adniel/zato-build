---

  - hosts: localhost

    tasks:

    # Prepare vars file for "build" provisioner
      - name: Add "system" variable
        replace: dest=./roles/build/vars/build_parameters.yml regexp="build_system" replace={{ system }}

      - name: Add "release_version" variable
        replace: dest=./roles/build/vars/build_parameters.yml regexp="build_release_version" replace={{ release_version }}

      - name: Add "package_version" variable
        replace: dest=./roles/build/vars/build_parameters.yml regexp="build_package_version" replace={{ package_version }}

      - name: Add "branch" variable
        replace: dest=./roles/build/vars/build_parameters.yml regexp="build_branch" replace={{ branch }}

    # Prepare build box
      - name: Prepare Vagrantfile
        shell: cp ./vm/{{ system }}/Vagrantfile.template ./vm/{{ system }}/Vagrantfile

      - name: Create directory to be synced
        file: path=./vm/{{ system }}/synced state=directory

      - name: Clone Zato repository to the synced directory
        git: repo=https://github.com/zatosource/zato-build.git dest=./vm/{{ system }}/synced clone=yes

      - name: Start a vagrant box
        shell: vagrant up --no-provision chdir=./vm/{{ system }}

    # Run the provisioner
      - name: Run the build provision
        shell: vagrant provision --provision-with build chdir=./vm/{{ system }}

