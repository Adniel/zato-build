---

#- hosts: aptly-test-box
#  vars_files:
#      - vars/vars.yml
#      - vars/parameters.yml
#  become: True
#  become_user: aptly

#  roles:

#      - add_package_to_repo

- include:  prepare_test_box.yml
  vars_files:
      - vars/parameters.yml
      - vars/vars.yml

- hosts: "{{ host }}"
  become: True
  vars_files:
      - vars/vars.yml
      - vars/parameters.yml

  roles:

      - prepare_install_zato

- hosts: "{{ host }}"
  become: True
  vars_files:
      - vars/vars.yml
      - vars/parameters.yml

  pre_tasks:

      - name: Update apt cache
        apt: update_cache=yes

      - name: Prepare additional variables
        script: ./files/get_zato_version.py {{ item.file }} {{ item.offset }}
        with_items:
            - { file: '/home/vagrant/latest.yml', offset: -1 }
            - { file: '/home/vagrant/previous.yml', offset: -2 }

      - name: Fetch new vars files
        fetch: src=/home/vagrant/{{ item }}
               dest={{ project_root }}/roles/test_aptly/vars/ flat=yes
        with_items:
            - latest.yml
            - previous.yml

  roles:

      - { role: install_zato, vars_files: latest.yml }

  tasks:

      - name: Register results
        shell: /opt/zato/{{ release_version }}/bin/zato --version
        become_user: zato
        register: zato_version_latest

      - assert:
          that:
            - "'Zato {{ release_version }}.rev' in zato_version_latest.stderr"

- include: clean.yml
  vars_files:
      - vars/parameters.yml
      - vars/vars.yml

- include:  prepare_test_box.yml
  vars_files:
      - vars/parameters.yml
      - vars/vars.yml

- hosts: "{{ host }}"
  become: True
  vars_files:
      - vars/vars.yml
      - vars/parameters.yml
      - roles/test_aptly/vars/previous.yml

  roles:

      - prepare_install_zato

  tasks:

      - name: Install Zato
        apt: name=zato={{ release_version }}-{{ package_version }}-{{ codename }}
             update_cache=yes
             state=present

      - name: Register results
        shell: /opt/zato/{{ release_version }}/bin/zato --version
        become_user: zato
        register: zato_version_previous

      - assert:
          that:
            - "'Zato {{ release_version }}.rev' in zato_version_previous.stderr"

- include: clean.yml
  vars_files:
      - vars/parameters.yml
      - vars/vars.yml


- include:  prepare_test_box.yml
  vars_files:
      - vars/parameters.yml
      - vars/vars.yml

- hosts: "{{ host }}"
  become: True
  vars_files:
      - vars/vars.yml
      - vars/parameters.yml
      - roles/test_aptly/vars/latest.yml

  roles:

      - prepare_install_zato

  tasks:

      - name: Install Zato
        apt: name=zato={{ release_version }}-{{ package_version }}-{{ codename }}
             update_cache=yes
             state=present

      - name: Register results
        shell: /opt/zato/{{ release_version }}/bin/zato --version
        become_user: zato
        register: zato_version_latest

      - assert:
          that:
            - "'Zato {{ release_version }}.rev' in zato_version_latest.stderr"

- include: clean.yml
  vars_files:
      - vars/parameters.yml
      - vars/vars.yml
