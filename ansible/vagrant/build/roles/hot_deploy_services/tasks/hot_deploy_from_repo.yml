---

#- name: Clone git repo
#  git: repo= git@bitbucket.org:dsuch/pah-zato-services.git
#       dest=/opt/zato/development

- name: Stop Zato components
  service: name=zato state=stopped
  become_user: root

- name: Wait for the servers to shutdown
  pause: seconds=30

- name: Check if the servers stopped
  command: /opt/zato/current/bin/zato info {{ item }}
         chdir=/opt/zato/env/qs-1/
  with_items:
      - server1
      - server2

- name: Add utils to zato_extra_paths
  shell: cp /opt/zato/services/zato_extra_paths/*.py \
         /opt/zato/current/zato_extra_paths

- name: Start Zato components
  service: name=zato state=restarted
  become_user: root

- name: Wait for the servers to get up
  pause: seconds=60

- name: Check if the servers are running
  command: /opt/zato/current/bin/zato info {{ item }}
         chdir=/opt/zato/env/qs-1/
  with_items:
      - server1
      - server2

- name: Move the services to pickup-dir
  shell: cp /opt/zato/services/services/*.py \
         /opt/zato/env/qs-1/{{ item }}/pickup-dir
  with_items:
      - server1
      - server2

- name: Copy BST definitions
  shell: cp -f /opt/zato/services/bst/outreach_intake.txt \
         /opt/zato/env/qs-1/{{ item }}/config/repo/proc/bst/
  with_items:
      - server1
      - server2

- name: Use zato enmasse
  shell: /opt/zato/current/bin/zato enmasse \
         /opt/zato/env/qs-1/server1/ \
         --input /opt/zato/services/server_objects/master-enmasse.json \
         --import \
         --replace-odb-object
