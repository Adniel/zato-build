---

    - name: Create a snapshot of the repository
      shell: aptly snapshot create \
        snap-zato-{{ package_version }}-{{ codename }}-{{ repo_datetime }} \
        from repo zato-{{ package_version }}-{{ codename }}
      register: snapshot_created

    - name: Drop the previous published repo
      shell: aptly publish drop {{ codename }} \
        repo/{{ package_version }}/2.0/{{ distribution }}

    - name: Publish the snapshot
      shell: aptly publish snapshot \
          snap-zato-{{ package_version }}-{{ codename }}-{{ repo_datetime }} \
        repo/{{ package_version }}/2.0/{{ distribution }}
      register: snapshot_published
      when: snapshot_created.changed == True
