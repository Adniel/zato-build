---

  - hosts: localhost

    tasks:

    # Prepare vars file for "test" provisioner
      - name: Add "system" variable
        replace: dest=./roles/test/vars/test_parameters.yml regexp="test_system" replace={{ system }}

      - name: Add "release_version" variable
        replace: dest=./roles/test/vars/test_parameters.yml regexp="test_release_version" replace={{ release_version }}

      - name: Add "package_version" variable
        replace: dest=./roles/test/vars/test_parameters.yml regexp="test_package_version" replace={{ package_version }}

    # Prepare test box
      - name: Prepare a Vagrantfile
        copy: src=./vm/{{ system }}/Vagrantfile.template dest=./vm/{{ system }}/Vagrantfile

      - name: Create a "synced" directory
        file: path=./vm/{{ system }}/synced state=directory

      - name: Create a vagrant box
        shell: vagrant up --no-provision chdir=./vm/{{ system }}

    # Run the provisioner
      - name: Run "test" provisioner
        shell: vagrant provision --provision-with=test chdir=./vm/{{ system }}

